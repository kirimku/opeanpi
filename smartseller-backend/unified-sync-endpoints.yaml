openapi: 3.0.3
info:
  title: Unified Sync Service API
  version: 2.0.0
  description: |
    Enterprise-grade Shopify synchronization API with advanced job management,
    rate limiting, webhook notifications, and loyalty referral processing.
    Replaces duplicate sync implementations with a unified, feature-rich service.
tags:
  - name: Unified Sync Service
    description: Advanced Shopify synchronization with job management and loyalty integration
paths:
  # High-Performance Unified Sync Endpoints
  /api/v1/admin/storefronts/{id}/shopify/sync/products/high-performance:
    post:
      summary: Trigger high-performance Shopify product sync (unified service)
      description: |
        Initiates a high-performance product synchronization using the unified sync service with:
        - Rate limiting and performance optimization
        - Real-time job tracking and progress monitoring
        - Webhook notifications for sync events
        - Advanced error handling and retry mechanisms
        - Loyalty referral processing integration
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
        - in: query
          name: limit
          required: false
          description: Maximum number of products to sync
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - in: query
          name: batch_size
          required: false
          description: Number of products to process per batch
          schema:
            type: integer
            minimum: 10
            maximum: 100
            default: 50
        - in: query
          name: parallel_jobs
          required: false
          description: Number of parallel processing jobs
          schema:
            type: integer
            minimum: 1
            maximum: 10
            default: 5
        - in: query
          name: full_sync
          required: false
          description: Force full resync instead of incremental
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Sync job started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '429':
          description: Rate limit exceeded
        '502':
          description: Bad Gateway
  /api/v1/admin/storefronts/{id}/shopify/sync/orders/high-performance:
    post:
      summary: Trigger high-performance Shopify order sync (unified service)
      description: |
        Initiates a high-performance order synchronization using the unified sync service with:
        - Rate limiting and performance optimization
        - Real-time job tracking and progress monitoring
        - Webhook notifications for sync events
        - Advanced error handling and retry mechanisms
        - Loyalty referral processing integration
        - Automatic point awarding for referral codes
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
        - in: query
          name: limit
          required: false
          description: Maximum number of orders to sync
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - in: query
          name: batch_size
          required: false
          description: Number of orders to process per batch
          schema:
            type: integer
            minimum: 10
            maximum: 100
            default: 50
        - in: query
          name: parallel_jobs
          required: false
          description: Number of parallel processing jobs
          schema:
            type: integer
            minimum: 1
            maximum: 10
            default: 5
        - in: query
          name: status
          required: false
          description: Filter orders by status
          schema:
            type: string
            enum: [open, closed, cancelled, any]
            default: any
        - in: query
          name: full_sync
          required: false
          description: Force full resync instead of incremental
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Sync job started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '429':
          description: Rate limit exceeded
        '502':
          description: Bad Gateway
  # Sync Job Management Endpoints
  /api/v1/admin/storefronts/{id}/shopify/sync/start:
    post:
      summary: Start a sync job for unified service
      description: |
        Starts a new sync job using the unified sync service with specified sync type.
        Supports products, orders, and inventory synchronization.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
          schema:
            $ref: '#/components/schemas/ShopifySyncStartRequest'
      responses:
        '200':
          description: Sync job started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
  /api/v1/admin/storefronts/{id}/shopify/sync/jobs:
    get:
      summary: List sync jobs for unified service
      description: |
        Retrieves a list of sync jobs with filtering and pagination options.
        Supports filtering by status, job type, and date range.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
        - in: query
          name: status
          required: false
          description: Filter by job status
          schema:
            type: string
            enum: [pending, running, paused, completed, failed, cancelled]
        - in: query
          name: job_type
          required: false
          description: Filter by job type
          schema:
            type: string
            enum: [products, orders, inventory]
        - in: query
          name: limit
          required: false
          description: Maximum number of jobs to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: offset
          required: false
          description: Number of jobs to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of sync jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobListResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
  /api/v1/admin/storefronts/{id}/shopify/sync/cancel:
    post:
      summary: Cancel a running sync job
      description: |
        Cancels a currently running or pending sync job.
        Completed jobs cannot be cancelled.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifySyncCancelRequest'
      responses:
        '200':
          description: Job cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Job not found
        '409':
          description: Cannot cancel job in current status
  /api/v1/admin/storefronts/{id}/shopify/sync/retry:
    post:
      summary: Retry a failed sync job
      description: |
        Retries a failed sync job with optional progress reset.
        Only jobs with 'failed' status can be retried.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifySyncRetryRequest'
      responses:
        '200':
          description: Job retry started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Job not found
        '409':
          description: Cannot retry job in current status
  /api/v1/admin/storefronts/{id}/shopify/sync/pause:
    post:
      summary: Pause a running sync job
      description: |
        Pauses a currently running sync job.
        Paused jobs can be resumed later.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifySyncPauseRequest'
      responses:
        '200':
          description: Job paused successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Job not found
        '409':
          description: Cannot pause job in current status
  /api/v1/admin/storefronts/{id}/shopify/sync/resume:
    post:
      summary: Resume a paused sync job
      description: |
        Resumes a previously paused sync job.
        Only jobs with 'paused' status can be resumed.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifySyncResumeRequest'
      responses:
        '200':
          description: Job resumed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Job not found
        '409':
          description: Cannot resume job in current status
  /api/v1/admin/storefronts/{id}/shopify/sync/logs:
    get:
      summary: Get sync job logs
      description: |
        Retrieves logs for a specific sync job or all jobs with filtering.
        Supports filtering by job ID, log level, and date range.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
        - in: query
          name: job_id
          required: false
          description: Filter by specific job ID
          schema:
            type: string
            format: uuid
        - in: query
          name: level
          required: false
          description: Filter by log level
          schema:
            type: string
            enum: [debug, info, warn, error]
        - in: query
          name: limit
          required: false
          description: Maximum number of log entries to return
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Sync logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncLogsResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
  /api/v1/admin/storefronts/{id}/shopify/sync/history:
    get:
      summary: Get sync job history
      description: |
        Retrieves historical sync jobs with comprehensive filtering options.
        Useful for analytics and reporting purposes.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
        - in: query
          name: status
          required: false
          description: Filter by job status
          schema:
            type: string
            enum: [pending, running, paused, completed, failed, cancelled]
        - in: query
          name: job_type
          required: false
          description: Filter by job type
          schema:
            type: string
            enum: [products, orders, inventory]
        - in: query
          name: date_from
          required: false
          description: Filter by start date
          schema:
            type: string
            format: date-time
        - in: query
          name: date_to
          required: false
          description: Filter by end date
          schema:
            type: string
            format: date-time
        - in: query
          name: limit
          required: false
          description: Maximum number of jobs to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - in: query
          name: offset
          required: false
          description: Number of jobs to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Job history retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncJobHistoryResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
  /api/v1/admin/storefronts/{id}/shopify/sync/performance:
    post:
      summary: Get sync job performance metrics
      description: |
        Retrieves detailed performance metrics for a specific sync job.
        Includes duration, processing speed, success rate, and recent logs.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifySyncPerformanceRequest'
      responses:
        '200':
          description: Performance metrics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncPerformanceResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Job not found
  /api/v1/admin/storefronts/{id}/shopify/sync/cleanup:
    post:
      summary: Clean up old sync data
      description: |
        Removes old sync data based on the specified age in days.
        Helps maintain database performance by cleaning up historical data.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifySyncCleanupRequest'
      responses:
        '200':
          description: Cleanup completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncCleanupResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
  # Webhook Notification Endpoints
  /api/v1/admin/storefronts/{id}/shopify/sync/webhooks/register:
    post:
      summary: Register webhook for sync notifications
      description: |
        Registers a webhook URL to receive real-time notifications about sync job events.
        Supported events include job started, progress, completed, failed, etc.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifySyncWebhookRegisterRequest'
      responses:
        '200':
          description: Webhook registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncWebhookResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '409':
          description: Webhook URL already registered
  /api/v1/admin/storefronts/{id}/shopify/sync/webhooks/unregister:
    delete:
      summary: Unregister webhook for sync notifications
      description: |
        Removes a previously registered webhook URL.
        No more notifications will be sent to this URL.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
        - in: query
          name: url
          required: true
          description: Webhook URL to unregister
          schema:
            type: string
            format: uri
      responses:
        '200':
          description: Webhook unregistered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncWebhookResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '404':
          description: Webhook not found
  /api/v1/admin/storefronts/{id}/shopify/sync/webhooks:
    get:
      summary: List registered webhooks for sync notifications
      description: |
        Retrieves a list of all registered webhook URLs for sync notifications.
        Each webhook receives real-time updates about sync job events.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhooks retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncWebhooksResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
  /api/v1/admin/storefronts/{id}/shopify/sync/webhooks/test:
    post:
      summary: Test webhook for sync notifications
      description: |
        Sends a test webhook notification to verify the endpoint is working correctly.
        Uses a sample sync job completion event for testing.
      tags:
        - Unified Sync Service
      parameters:
        - in: path
          name: id
          required: true
          description: Storefront ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShopifySyncWebhookTestRequest'
      responses:
        '200':
          description: Webhook test completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopifySyncWebhookTestResponse'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized
        '500':
          description: Webhook test failed
components:
  schemas:
    # Unified Sync Job Schemas
    ShopifySyncJobResponse:
      type: object
      required: [job_id, status, job_type]
      properties:
        job_id:
          type: string
          format: uuid
          description: Unique identifier for the sync job
        status:
          type: string
          enum: [pending, running, paused, completed, failed, cancelled]
          description: Current status of the sync job
        job_type:
          type: string
          enum: [products, orders, inventory]
          description: Type of synchronization being performed
        integration_id:
          type: string
          format: uuid
          description: Shopify integration ID being used
        storefront_id:
          type: string
          format: uuid
          description: Storefront ID
        total_items:
          type: integer
          description: Total items to process
        processed_items:
          type: integer
          description: Number of items processed so far
        failed_items:
          type: integer
          description: Number of items that failed to process
        progress_percentage:
          type: number
          format: float
          description: Progress percentage (0-100)
        created_at:
          type: string
          format: date-time
          description: When the job was created
        started_at:
          type: string
          format: date-time
          description: When the job started processing
        completed_at:
          type: string
          format: date-time
          description: When the job completed
        duration_seconds:
          type: number
          description: Total duration in seconds
        error_message:
          type: string
          description: Error message if job failed
        metadata:
          type: object
          description: Additional job metadata
          properties:
            rate_limit_status:
              type: object
              description: Current rate limiting status
            webhook_notifications:
              type: array
              items:
                type: string
              description: List of registered webhook URLs
    ShopifySyncStartRequest:
      type: object
      required: [sync_type]
      properties:
        sync_type:
          type: string
          enum: [products, orders, inventory]
          description: Type of sync to start
        integration_id:
          type: string
          format: uuid
          description: Shopify integration ID to use
        priority:
          type: string
          enum: [low, normal, high]
          default: normal
          description: Job priority
        auto_retry:
          type: boolean
          default: true
          description: Whether to automatically retry failed jobs
        metadata:
          type: object
          description: Additional job metadata
    ShopifySyncCancelRequest:
      type: object
      required: [job_id]
      properties:
        job_id:
          type: string
          format: uuid
          description: Job ID to cancel
        reason:
          type: string
          description: Reason for cancellation
    ShopifySyncRetryRequest:
      type: object
      required: [job_id]
      properties:
        job_id:
          type: string
          format: uuid
          description: Job ID to retry
        reset_progress:
          type: boolean
          default: false
          description: Whether to reset progress to zero
        retry_count:
          type: integer
          default: 1
          description: Maximum number of retry attempts
    ShopifySyncPauseRequest:
      type: object
      required: [job_id]
      properties:
        job_id:
          type: string
          format: uuid
          description: Job ID to pause
        reason:
          type: string
          description: Reason for pausing
    ShopifySyncResumeRequest:
      type: object
      required: [job_id]
      properties:
        job_id:
          type: string
          format: uuid
          description: Job ID to resume
    ShopifySyncCleanupRequest:
      type: object
      properties:
        older_than_days:
          type: integer
          minimum: 1
          maximum: 365
          default: 30
          description: Remove data older than this many days
        include_completed:
          type: boolean
          default: true
          description: Whether to include completed jobs
        include_failed:
          type: boolean
          default: true
          description: Whether to include failed jobs
    ShopifySyncCleanupResponse:
      type: object
      properties:
        jobs_deleted:
          type: integer
          description: Number of jobs deleted
        logs_deleted:
          type: integer
          description: Number of log entries deleted
        space_freed_mb:
          type: number
          description: Estimated space freed in MB
    ShopifySyncJobListResponse:
      type: object
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/ShopifySyncJobResponse'
        total:
          type: integer
          description: Total number of jobs
        limit:
          type: integer
          description: Number of jobs returned
        offset:
          type: integer
          description: Number of jobs skipped
    ShopifySyncJobHistoryResponse:
      type: object
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/ShopifySyncJobResponse'
        total:
          type: integer
          description: Total number of jobs in history
        date_range:
          type: object
          properties:
            from:
              type: string
              format: date-time
            to:
              type: string
              format: date-time
        statistics:
          type: object
          properties:
            success_rate:
              type: number
              description: Overall success rate percentage
            average_duration:
              type: number
              description: Average job duration in seconds
            total_processed:
              type: integer
              description: Total items processed across all jobs
    ShopifySyncLogsResponse:
      type: object
      properties:
        logs:
          type: array
          items:
            $ref: '#/components/schemas/ShopifySyncLog'
        total:
          type: integer
          description: Total number of log entries
        limit:
          type: integer
          description: Number of logs returned
        has_more:
          type: boolean
          description: Whether more logs are available
    ShopifySyncLog:
      type: object
      properties:
        id:
          type: string
          format: uuid
        job_id:
          type: string
          format: uuid
        level:
          type: string
          enum: [debug, info, warn, error]
        message:
          type: string
        details:
          type: object
          description: Additional log details
        created_at:
          type: string
          format: date-time
    ShopifySyncPerformanceRequest:
      type: object
      required: [job_id]
      properties:
        job_id:
          type: string
          format: uuid
          description: Job ID to analyze
        include_recent_logs:
          type: boolean
          default: true
          description: Include recent log entries
        log_count:
          type: integer
          minimum: 5
          maximum: 50
          default: 20
          description: Number of recent logs to include
    ShopifySyncPerformanceResponse:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
          description: Job ID
        job_type:
          type: string
          enum: [products, orders, inventory]
          description: Job type
        status:
          type: string
          enum: [pending, running, paused, completed, failed, cancelled]
          description: Current job status
        total_items:
          type: integer
          description: Total items to process
        processed_items:
          type: integer
          description: Items processed successfully
        failed_items:
          type: integer
          description: Items that failed to process
        success_rate:
          type: number
          format: float
          description: Success rate percentage (0-100)
        duration_seconds:
          type: number
          description: Total job duration in seconds
        items_per_second:
          type: number
          description: Items processed per second
        recent_logs:
          type: array
          items:
            $ref: '#/components/schemas/ShopifySyncLog'
          description: Recent log entries
        performance_metrics:
          type: object
          properties:
            api_calls_made:
              type: integer
              description: Total API calls made
            api_calls_successful:
              type: integer
              description: Successful API calls
            rate_limit_hits:
              type: integer
              description: Number of rate limit hits
            throughput_mb_per_second:
              type: number
              description: Data throughput in MB/s
    # Webhook Schemas
    ShopifySyncWebhookRegisterRequest:
      type: object
      required: [webhook_url]
      properties:
        webhook_url:
          type: string
          format: uri
          description: Webhook URL to register
        events:
          type: array
          items:
            type: string
            enum: [job.started, job.progress, job.completed, job.failed, job.cancelled, job.paused, job.resumed]
          description: Events to receive notifications for
          description: Optional description for the webhook
        secret:
          type: string
          description: Optional secret for webhook validation
    ShopifySyncWebhookResponse:
      type: object
      properties:
        webhook_id:
          type: string
          format: uuid
          description: Unique webhook identifier
        webhook_url:
          type: string
          format: uri
          description: Registered webhook URL
        events:
          type: array
          items:
            type: string
            enum: [job.started, job.progress, job.completed, job.failed, job.cancelled, job.paused, job.resumed]
          description: Events subscribed to
        is_active:
          type: boolean
          description: Whether the webhook is active
        registered_at:
          type: string
          format: date-time
          description: When the webhook was registered
        last_triggered:
          type: string
          format: date-time
          description: Last time the webhook was triggered
    ShopifySyncWebhooksResponse:
      type: object
      properties:
        webhooks:
          type: array
          items:
            $ref: '#/components/schemas/ShopifySyncWebhookResponse'
          description: List of registered webhooks
        total:
          type: integer
          description: Total number of registered webhooks
    ShopifySyncWebhookTestRequest:
      type: object
      required: [webhook_url]
      properties:
        webhook_url:
          type: string
          format: uri
          description: Webhook URL to test
        test_event:
          type: string
          enum: [job.completed, job.progress, job.failed]
          default: job.completed
          description: Event type to test
    ShopifySyncWebhookTestResponse:
      type: object
      properties:
        webhook_url:
          type: string
          format: uri
          description: Tested webhook URL
        test_result:
          type: string
          enum: [success, failed, timeout]
          description: Result of the webhook test
        test_event:
          type: string
          description: Event type that was tested
        response_status:
          type: integer
          description: HTTP status code from webhook
        response_time_ms:
          type: number
          description: Webhook response time in milliseconds
        error_message:
          type: string
          description: Error message if test failed