openapi: 3.0.3
info:
  title: SmartSeller Loyalty Customer API
  description: |
    API for customers to manage their loyalty accounts, view transaction history,
    track referrals, and monitor tier progress.
  version: 1.0.0
  contact:
    name: SmartSeller API Team
    email: api@smartseller.com

servers:
  - url: http://localhost:8090
    description: Development server
  - url: https://api.smartseller.com
    description: Production server

tags:
  - name: Loyalty Account
    description: Customer loyalty account management
  - name: Loyalty Transactions
    description: Transaction history and points tracking
  - name: Loyalty Referrals
    description: Referral code generation and tracking
  - name: Loyalty Tiers
    description: Tier information and progress tracking

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Customer JWT token from authentication

  schemas:
    LoyaltyAccountResponse:
      type: object
      description: Complete loyalty account information
      properties:
        id:
          type: string
          format: uuid
          description: Account unique identifier
        customer_id:
          type: string
          format: uuid
          description: Customer unique identifier
        storefront_id:
          type: string
          format: uuid
          description: Storefront unique identifier
        total_points_earned:
          type: integer
          description: Total points earned lifetime
        total_points_redeemed:
          type: integer
          description: Total points redeemed lifetime
        total_points_expired:
          type: integer
          description: Total points that have expired
        current_balance:
          type: integer
          description: Current point balance
        pending_points:
          type: integer
          description: Points pending confirmation
        available_balance:
          type: integer
          description: Available balance (current - pending)
        current_tier:
          type: string
          enum: [bronze, silver, gold, platinum]
          description: Current tier level
        tier_start_date:
          type: string
          format: date-time
          description: When current tier was achieved
        points_to_next_tier:
          type: integer
          description: Points needed to reach next tier
        tier_benefits:
          $ref: '#/components/schemas/TierBenefits'
        points_earned_last_12_months:
          type: integer
          description: Points earned in trailing 12 months
        tier_evaluation_date:
          type: string
          format: date
          description: Next tier evaluation date
        status:
          type: string
          enum: [active, inactive, suspended]
          description: Account status
        is_frozen:
          type: boolean
          description: Whether account is frozen
        frozen_reason:
          type: string
          description: Reason for account freeze (if frozen)
        lifetime_orders_count:
          type: integer
          description: Total orders placed
        lifetime_spend:
          type: number
          format: float
          description: Total amount spent
        referral_count:
          type: integer
          description: Number of successful referrals
        review_count:
          type: integer
          description: Number of reviews submitted
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - customer_id
        - storefront_id
        - current_balance
        - pending_points
        - available_balance
        - current_tier
        - status

    BalanceResponse:
      type: object
      description: Simplified balance summary
      properties:
        current_balance:
          type: integer
          description: Current point balance
        pending_points:
          type: integer
          description: Points pending confirmation
        available_balance:
          type: integer
          description: Available for redemption
        total_points_earned:
          type: integer
          description: Lifetime points earned
        updated_at:
          type: string
          format: date-time
      required:
        - current_balance
        - available_balance

    TierBenefits:
      type: object
      properties:
        points_multiplier:
          type: number
          format: float
          description: Points earning multiplier
          example: 1.5
        free_shipping:
          type: boolean
          description: Free shipping eligibility
        birthday_bonus:
          type: integer
          description: Birthday bonus points
        priority_support:
          type: boolean
          description: Priority customer support
        exclusive_offers:
          type: boolean
          description: Access to exclusive offers

    TransactionItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [earn, redeem, expire, reversal, adjustment, bonus, refund]
          description: Transaction type
        status:
          type: string
          enum: [pending, completed, failed, reversed]
          description: Transaction status
        points:
          type: integer
          description: Points amount (positive for earn, negative for redeem)
        balance_after:
          type: integer
          description: Account balance after transaction
        description:
          type: string
          description: Human-readable description
        source:
          type: string
          enum: [order, referral, review, birthday, signup, manual, promotion, tier_upgrade, social_share, survey]
          description: Points source
        source_id:
          type: string
          format: uuid
          nullable: true
          description: Related entity ID (order_id, etc.)
        idempotency_key:
          type: string
          nullable: true
          description: Duplicate prevention key
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: When points expire
        is_reversed:
          type: boolean
          description: Whether transaction was reversed
        reversal_of:
          type: string
          format: uuid
          nullable: true
          description: ID of transaction being reversed
        reversed_by:
          type: string
          format: uuid
          nullable: true
          description: ID of transaction that reversed this
        created_at:
          type: string
          format: date-time
      required:
        - id
        - type
        - status
        - points
        - balance_after
        - description
        - source
        - created_at

    TransactionHistoryResponse:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/TransactionItem'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'

    PaginationInfo:
      type: object
      properties:
        current_page:
          type: integer
          minimum: 1
        per_page:
          type: integer
          minimum: 1
          maximum: 100
        total_records:
          type: integer
          minimum: 0
        total_pages:
          type: integer
          minimum: 0
        has_next:
          type: boolean
        has_previous:
          type: boolean
      required:
        - current_page
        - per_page
        - total_records
        - total_pages
        - has_next
        - has_previous

    ReferralItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        referral_code:
          type: string
          description: Unique referral code
        status:
          type: string
          enum: [pending, signup_completed, order_completed, rewarded, expired, cancelled]
          description: Referral status
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
        referee_email:
          type: string
          nullable: true
          description: Email of referred person
        referee_name:
          type: string
          nullable: true
          description: Name of referred person
        referrer_points:
          type: integer
          description: Points referrer will earn
        referrer_points_awarded:
          type: integer
          description: Points actually awarded to referrer
        referrer_transaction_id:
          type: string
          format: uuid
          nullable: true
          description: Transaction ID for referrer points
        first_order_id:
          type: string
          format: uuid
          nullable: true
          description: First order ID from referral
        first_order_completed_at:
          type: string
          format: date-time
          nullable: true
          description: When first order was completed
        conversion_rate:
          type: number
          format: float
          description: Conversion percentage
        days_until_expiry:
          type: integer
          nullable: true
          description: Days until referral expires
      required:
        - id
        - referral_code
        - status
        - created_at

    ReferralListResponse:
      type: object
      properties:
        referrals:
          type: array
          items:
            $ref: '#/components/schemas/ReferralItem'
        summary:
          $ref: '#/components/schemas/ReferralSummary'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'

    ReferralSummary:
      type: object
      properties:
        total_referrals:
          type: integer
        pending_referrals:
          type: integer
        completed_referrals:
          type: integer
        expired_referrals:
          type: integer
        total_points_earned:
          type: integer

    GenerateReferralResponse:
      type: object
      properties:
        referral_code:
          type: string
          description: Generated referral code
        share_url:
          type: string
          format: uri
          description: Shareable referral URL
        expires_at:
          type: string
          format: date-time
          description: Referral expiration date
        validity_days:
          type: integer
          description: Number of days until expiration
      required:
        - referral_code
        - share_url
        - expires_at

    TierInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          enum: [bronze, silver, gold, platinum]
        display_name:
          type: string
        description:
          type: string
        min_points:
          type: integer
          description: Minimum points required
        max_points:
          type: integer
          nullable: true
          description: Maximum points (null for highest tier)
        points_multiplier:
          type: number
          format: float
          description: Points earning multiplier
        benefits:
          $ref: '#/components/schemas/TierBenefits'
        is_current:
          type: boolean
          description: Whether this is customer's current tier
        is_next:
          type: boolean
          description: Whether this is customer's next tier
        progress_percentage:
          type: number
          format: float
          nullable: true
          description: Progress toward this tier (0-100)
      required:
        - id
        - name
        - display_name
        - min_points
        - points_multiplier

    TierListResponse:
      type: object
      properties:
        tiers:
          type: array
          items:
            $ref: '#/components/schemas/TierInfo'
      required:
        - tiers

    CurrentTierResponse:
      type: object
      properties:
        tier:
          $ref: '#/components/schemas/TierInfo'
        points_in_tier:
          type: integer
          description: Points earned at current tier
        tier_start_date:
          type: string
          format: date-time
        points_to_maintain:
          type: integer
          description: Points needed to maintain tier
        evaluation_date:
          type: string
          format: date-time
          description: Next evaluation date
      required:
        - tier
        - points_in_tier

    NextTierResponse:
      type: object
      properties:
        next_tier:
          $ref: '#/components/schemas/TierInfo'
          nullable: true
        points_needed:
          type: integer
          description: Points needed to reach next tier
        estimated_date:
          type: string
          format: date-time
          nullable: true
          description: Estimated date to reach next tier
        requirements:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [points, orders, spend, referrals]
              current:
                type: number
              required:
                type: number
              description:
                type: string
              achieved:
                type: boolean
      required:
        - points_needed
        - requirements

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        error:
          type: string
          description: Error code
        error_detail:
          type: string
          description: Detailed error message
        validation_errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

paths:
  /api/v1/storefront/{slug}/loyalty/account:
    get:
      tags:
        - Loyalty Account
      summary: Get loyalty account
      description: |
        Retrieves the complete loyalty account information for the authenticated customer.
        Account is auto-created if it doesn't exist.
      operationId: getLoyaltyAccount
      security:
        - BearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          description: Storefront slug
          schema:
            type: string
            example: rexus
      responses:
        '200':
          description: Loyalty account retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/LoyaltyAccountResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Loyalty account retrieved successfully"
                    data:
                      id: "b0713dea-5b83-4184-ba52-8a42174534f4"
                      customer_id: "550e8400-e29b-41d4-a716-446655440000"
                      storefront_id: "660e8400-e29b-41d4-a716-446655440000"
                      total_points_earned: 4490
                      total_points_redeemed: 0
                      total_points_expired: 0
                      current_balance: 4490
                      pending_points: 0
                      available_balance: 4490
                      current_tier: bronze
                      tier_start_date: "2026-01-08T00:00:00Z"
                      points_to_next_tier: 5510
                      tier_benefits:
                        points_multiplier: 1.0
                        free_shipping: false
                        birthday_bonus: 0
                        priority_support: false
                        exclusive_offers: false
                      points_earned_last_12_months: 4490
                      tier_evaluation_date: "2026-02-08"
                      status: active
                      is_frozen: false
                      lifetime_orders_count: 1
                      lifetime_spend: 449000.0
                      referral_count: 0
                      review_count: 0
                      created_at: "2026-01-08T00:00:00Z"
                      updated_at: "2026-01-08T22:31:37Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/storefront/{slug}/loyalty/balance:
    get:
      tags:
        - Loyalty Account
      summary: Get point balance summary
      description: |
        Returns a simplified response with just the essential balance information.
        Use this for quick balance checks in headers, widgets, etc.
      operationId: getLoyaltyBalance
      security:
        - BearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          description: Storefront slug
          schema:
            type: string
            example: rexus
      responses:
        '200':
          description: Balance retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/BalanceResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Balance retrieved successfully"
                    data:
                      current_balance: 4490
                      pending_points: 0
                      available_balance: 4490
                      total_points_earned: 4490
                      updated_at: "2026-01-08T22:31:37Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/storefront/{slug}/loyalty/transactions:
    get:
      tags:
        - Loyalty Transactions
      summary: Get transaction history
      description: |
        Retrieves paginated transaction history for the authenticated customer.
        Supports filtering by transaction type, source, and date range.
      operationId: getLoyaltyTransactions
      security:
        - BearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          description: Storefront slug
          schema:
            type: string
            example: rexus
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          description: Items per page (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: type
          in: query
          description: Filter by transaction type
          schema:
            type: string
            enum: [earn, redeem, expire, reversal, adjustment, bonus, refund]
        - name: source
          in: query
          description: Filter by source type
          schema:
            type: string
            enum: [order, referral, review, birthday, signup, manual, promotion, tier_upgrade, social_share, survey]
        - name: start_date
          in: query
          description: Filter transactions from this date
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          description: Filter transactions until this date
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Transactions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/TransactionHistoryResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Transactions retrieved successfully"
                    data:
                      transactions:
                        - id: "tx-uuid-1"
                          type: earn
                          status: completed
                          points: 4490
                          balance_after: 4490
                          description: "Points earned from order #1026"
                          source: order
                          source_id: "fb6ff4d7-aa24-40c6-8258-d26a938e5e20"
                          idempotency_key: "order_completed_fb6ff4d7-aa24-40c6-8258-d26a938e5e20"
                          expires_at: null
                          is_reversed: false
                          created_at: "2026-01-08T22:31:37Z"
                      pagination:
                        current_page: 1
                        per_page: 20
                        total_records: 1
                        total_pages: 1
                        has_next: false
                        has_previous: false
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/storefront/{slug}/loyalty/referrals:
    get:
      tags:
        - Loyalty Referrals
      summary: Get referral history
      description: |
        Retrieves paginated list of referrals created by the customer.
        Shows pending, completed, and expired referrals with conversion tracking.
      operationId: getLoyaltyReferrals
      security:
        - BearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          description: Storefront slug
          schema:
            type: string
            example: rexus
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          description: Items per page (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: status
          in: query
          description: Filter by referral status
          schema:
            type: string
            enum: [pending, signup_completed, order_completed, rewarded, expired, cancelled]
      responses:
        '200':
          description: Referrals retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/ReferralListResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Referrals retrieved successfully"
                    data:
                      referrals:
                        - id: "7ac49b56-90be-4933-85d0-3756f34481ca"
                          referral_code: TESTASWIN3
                          status: pending
                          created_at: "2026-01-01T00:00:00Z"
                          expires_at: "2026-02-01T00:00:00Z"
                          referee_email: null
                          referrer_points: 1000
                          referrer_points_awarded: 0
                          referrer_transaction_id: null
                          first_order_id: null
                          days_until_expiry: 30
                      summary:
                        total_referrals: 1
                        pending_referrals: 1
                        completed_referrals: 0
                        expired_referrals: 0
                        total_points_earned: 0
                      pagination:
                        current_page: 1
                        per_page: 20
                        total_records: 1
                        total_pages: 1
                        has_next: false
                        has_previous: false
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/storefront/{slug}/loyalty/referral/generate:
    post:
      tags:
        - Loyalty Referrals
      summary: Generate referral code
      description: |
        Generates a new referral code for the customer. Only one active referral
        code is allowed per customer at a time. Existing pending referral will be
        expired if a new one is generated.
      operationId: generateReferralCode
      security:
        - BearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          description: Storefront slug
          schema:
            type: string
            example: rexus
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                validity_days:
                  type: integer
                  minimum: 1
                  maximum: 365
                  default: 30
                  description: Number of days until referral expires
                referee_email:
                  type: string
                  format: email
                  description: Optional email of person being referred
      responses:
        '200':
          description: Referral code generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/GenerateReferralResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Referral code generated successfully"
                    data:
                      referral_code: TESTASWIN3
                      share_url: "https://store.example.com?ref=TESTASWIN3"
                      expires_at: "2026-02-08T00:00:00Z"
                      validity_days: 30
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Referral program not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/storefront/{slug}/loyalty/tiers:
    get:
      tags:
        - Loyalty Tiers
      summary: Get available tiers
      description: |
        Returns list of all available loyalty tiers with benefits and point requirements.
        Includes progress indicators for current and next tiers.
      operationId: getLoyaltyTiers
      security:
        - BearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          description: Storefront slug
          schema:
            type: string
            example: rexus
      responses:
        '200':
          description: Tiers retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/TierListResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Tiers retrieved successfully"
                    data:
                      tiers:
                        - id: "tier-bronze-id"
                          name: bronze
                          display_name: Bronze
                          description: Entry-level tier
                          min_points: 0
                          max_points: 9999
                          points_multiplier: 1.0
                          benefits:
                            points_multiplier: 1.0
                            free_shipping: false
                            birthday_bonus: 0
                            priority_support: false
                            exclusive_offers: false
                          is_current: true
                          is_next: false
                          progress_percentage: null
                        - id: "tier-silver-id"
                          name: silver
                          display_name: Silver
                          description: Mid-tier membership
                          min_points: 10000
                          max_points: 49999
                          points_multiplier: 1.25
                          benefits:
                            points_multiplier: 1.25
                            free_shipping: true
                            birthday_bonus: 100
                            priority_support: false
                            exclusive_offers: false
                          is_current: false
                          is_next: true
                          progress_percentage: 81.5
                        - id: "tier-gold-id"
                          name: gold
                          display_name: Gold
                          description: Premium membership
                          min_points: 50000
                          max_points: 99999
                          points_multiplier: 1.5
                          benefits:
                            points_multiplier: 1.5
                            free_shipping: true
                            birthday_bonus: 200
                            priority_support: true
                            exclusive_offers: false
                          is_current: false
                          is_next: false
                          progress_percentage: null
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/storefront/{slug}/loyalty/tier/current:
    get:
      tags:
        - Loyalty Tiers
      summary: Get current tier
      description: |
        Returns detailed information about customer's current tier,
        including points earned at this tier and next evaluation date.
      operationId: getCurrentTier
      security:
        - BearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          description: Storefront slug
          schema:
            type: string
            example: rexus
      responses:
        '200':
          description: Current tier retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/CurrentTierResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Current tier retrieved successfully"
                    data:
                      tier:
                        id: tier-bronze-id
                        name: bronze
                        display_name: Bronze
                        min_points: 0
                        points_multiplier: 1.0
                        benefits:
                          points_multiplier: 1.0
                          free_shipping: false
                        is_current: true
                      points_in_tier: 4490
                      tier_start_date: "2026-01-08T00:00:00Z"
                      points_to_maintain: 10000
                      evaluation_date: "2026-02-08T00:00:00Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/storefront/{slug}/loyalty/tier/next:
    get:
      tags:
        - Loyalty Tiers
      summary: Get next tier requirements
      description: |
        Returns information about the next tier and requirements to reach it.
        Includes points needed and progress tracking.
      operationId: getNextTierRequirements
      security:
        - BearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          description: Storefront slug
          schema:
            type: string
            example: rexus
      responses:
        '200':
          description: Next tier requirements retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/NextTierResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Next tier requirements retrieved successfully"
                    data:
                      next_tier:
                        id: tier-silver-id
                        name: silver
                        display_name: Silver
                        min_points: 10000
                        points_multiplier: 1.25
                        benefits:
                          points_multiplier: 1.25
                          free_shipping: true
                          birthday_bonus: 100
                      points_needed: 5510
                      estimated_date: "2026-03-15T00:00:00Z"
                      requirements:
                        - type: points
                          current: 4490
                          required: 10000
                          description: "Earn 10,000 lifetime points"
                          achieved: false
                        - type: orders
                          current: 1
                          required: 5
                          description: "Place 5 orders"
                          achieved: false
                        - type: spend
                          current: 449000
                          required: 1000000
                          description: "Spend 1,000,000 total"
                          achieved: false
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Already at highest tier
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "You are already at the highest tier"
                  data:
                    type: object
                    nullable: true
                    example: null
