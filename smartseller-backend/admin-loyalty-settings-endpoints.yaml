# Admin Loyalty Settings Endpoints
# OpenAPI specification for admin loyalty program configuration

paths:
  /api/v1/admin/loyalty/settings:
    get:
      summary: Get loyalty program settings
      description: Retrieve the current loyalty program configuration for the admin's storefront
      operationId: getAdminLoyaltySettings
      tags:
        - Admin Loyalty
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Settings retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Settings retrieved successfully"
                  data:
                    $ref: ''./schemas.yaml#/schemas/LoyaltySettings'
              examples:
                success:
                  summary: Successful response
                  value:
                    success: true
                    message: "Settings retrieved successfully"
                    data:
                      id: "9aec4999-c858-422f-b27e-88246ea547d5"
                      storefront_id: "b0ea82e3-366d-49a4-8c03-316a1ac2a2c4"
                      is_active: true
                      points_per_currency: "1"
                      currency_per_point: "0.01"
                      default_expiry_days: 365
                      expiration_strategy: "fifo"
                      enable_expiry_warnings: true
                      settings:
                        program_name: "Rexus Rewards"
                        program_description: "Earn points with every purchase"
                        min_redemption_points: 100
                        max_redemption_percentage: 50
                        redemption_increments: 100
                        tier_evaluation_period_days: 30
                        allow_point_transfers: false
                        allow_negative_balance: false
                        referrer_bonus_points: 500
                        referee_bonus_points: 250
                        referral_validity_days: 30
                        review_reward_points: 50
                        birthday_reward_points: 100
                        signup_bonus_points: 100
                        max_points_per_order: null
                        notify_on_points_earned: true
                        notify_on_points_expiring: true
                        notify_on_tier_change: true
                        expiry_warning_days: 30
                        enable_referral_program: true
                        enable_review_rewards: true
                        enable_birthday_rewards: true
                        enable_signup_bonus: true
                        enable_tier_system: true
                        custom_settings: {}
                      created_at: "2024-11-15T10:30:00+07:00"
                      updated_at: "2024-11-17T16:25:00+07:00"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      summary: Update loyalty program settings
      description: Update loyalty program configuration. All fields are optional - only send fields you want to change.
      operationId: updateAdminLoyaltySettings
      tags:
        - Admin Loyalty
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: ''./schemas.yaml#/schemas/UpdateSettingsRequest'
            examples:
              updateConversionRates:
                summary: Update conversion rates
                value:
                  points_per_currency: "2.0"
                  currency_per_point: "0.005"
              enableProgram:
                summary: Enable/disable program
                value:
                  is_active: true
              updateExpiration:
                summary: Update expiration settings
                value:
                  default_expiry_days: 365
                  expiration_strategy: "fifo"
                  enable_expiry_warnings: true
      responses:
        '200':
          description: Settings updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Settings updated successfully"
                  data:
                    $ref: ''./schemas.yaml#/schemas/UpdateSettingsResponse'
              examples:
                success:
                  summary: Successful update
                  value:
                    success: true
                    message: "Settings updated successfully"
                    data:
                      id: "9aec4999-c858-422f-b27e-88246ea547d5"
                      message: "Loyalty program settings updated successfully"
                      updated_at: "2024-11-17T16:30:15+07:00"
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/v1/admin/loyalty/tiers:
    get:
      summary: Get all loyalty tiers
      description: Retrieve all loyalty tier definitions (Bronze, Silver, Gold, Platinum)
      operationId: getAdminLoyaltyTiers
      tags:
        - Admin Loyalty
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Tiers retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      tiers:
                        type: array
                        items:
                          $ref: ''./schemas.yaml#/schemas/LoyaltyTier'
                      total_count:
                        type: integer
                      active_count:
                        type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/admin/loyalty/rules:
    get:
      summary: Get all loyalty rules
      description: Retrieve all loyalty earning rules and bonuses
      operationId: getAdminLoyaltyRules
      tags:
        - Admin Loyalty
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Rules retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      rules:
                        type: array
                        items:
                          $ref: ''./schemas.yaml#/schemas/LoyaltyRule'
                      total_count:
                        type: integer
                      active_count:
                        type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/v1/admin/loyalty/affiliates:
    get:
      summary: List all affiliates (referrers)
      description: |
        Retrieve a paginated list of customers who have made referrals.
        Affiliates are customers with referral codes who have successfully referred other customers.

        **Affiliate Status Calculation:**
        - `active`: Has made at least one referral within the last 30 days
        - `inactive`: No referrals in the last 30+ days
        - `new`: Joined the referral program within the last 7 days

        **Features:**
        - Filter by status (active, inactive, new)
        - Search by customer name, email, or phone
        - Sort by joined date, total referrals, or last referral date
        - Paginated results with metadata
      operationId: listAdminAffiliates
      tags:
        - Admin Loyalty
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number (defaults to 1)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
        - name: per_page
          in: query
          description: Number of items per page (defaults to 20, max 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        - name: status
          in: query
          description: Filter by affiliate activity status
          required: false
          schema:
            type: string
            enum: [active, inactive, new]
          example: active
        - name: search
          in: query
          description: Search by customer name, email, or phone number
          required: false
          schema:
            type: string
            maxLength: 255
          example: "john@example.com"
        - name: sort_by
          in: query
          description: Sort field (defaults to joined_at)
          required: false
          schema:
            type: string
            enum: [joined_at, total_referrals, last_referral_date]
            default: joined_at
          example: joined_at
        - name: sort_desc
          in: query
          description: Sort in descending order (defaults to true)
          required: false
          schema:
            type: boolean
            default: true
          example: true
      responses:
        '200':
          description: Affiliates retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Affiliates retrieved successfully"
                  data:
                    $ref: '#/components/schemas/AffiliateListResponse'
              examples:
                success:
                  summary: Successful response with affiliates
                  value:
                    success: true
                    message: "Affiliates retrieved successfully"
                    data:
                      affiliates:
                        - customer_id: "8149a7e1-0b1b-4245-9562-4e277582537c"
                          customer_name: "John Doe"
                          customer_email: "john.doe@example.com"
                          customer_phone: "+1234567890"
                          referral_code: "REF-ABC123"
                          status: "active"
                          total_referrals: 15
                          joined_at: "2024-01-15T10:30:00+07:00"
                          last_referral_date: "2024-12-28T14:20:00+07:00"
                          special_rules:
                            - rule_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                              rule_name: "VIP Referrer Bonus"
                              rule_type: "referral"
                              calculation_type: "fixed_points"
                              points_value: 500
                              priority: 10
                              is_active: true
                        - customer_id: "9aec4999-c858-422f-b27e-88246ea547d5"
                          customer_name: "Jane Smith"
                          customer_email: "jane.smith@example.com"
                          customer_phone: null
                          referral_code: "REF-DEF456"
                          status: "inactive"
                          total_referrals: 5
                          joined_at: "2024-06-20T09:15:00+07:00"
                          last_referral_date: "2024-11-15T11:45:00+07:00"
                          special_rules: []
                      pagination:
                        page: 1
                        per_page: 20
                        total: 45
                        total_pages: 3
                        has_next: true
                        has_previous: false
                empty:
                  summary: No affiliates found
                  value:
                    success: true
                    message: "Affiliates retrieved successfully"
                    data:
                      affiliates: []
                      pagination:
                        page: 1
                        per_page: 20
                        total: 0
                        total_pages: 0
                        has_next: false
                        has_previous: false
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /api/v1/auth/login

  schemas:
    LoyaltySettings:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique settings ID
        storefront_id:
          type: string
          format: uuid
          description: Storefront these settings belong to
        is_active:
          type: boolean
          description: Whether loyalty program is enabled
        points_per_currency:
          type: string
          pattern: '^\d+(\.\d+)?$'
          description: Points earned per $1 spent (e.g., "1" = 1 point per dollar)
          example: "1"
        currency_per_point:
          type: string
          pattern: '^\d+(\.\d+)?$'
          description: Dollar value per point redeemed (e.g., "0.01" = 100 points = $1)
          example: "0.01"
        default_expiry_days:
          type: integer
          nullable: true
          description: Days until points expire (null = never expire)
          example: 365
        expiration_strategy:
          type: string
          enum: [fifo, lifo]
          description: Which points expire first - FIFO (first-in-first-out) or LIFO (last-in-first-out)
        enable_expiry_warnings:
          type: boolean
          description: Send warnings before points expire
        settings:
          $ref: ''./schemas.yaml#/schemas/ProgramSettings'
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp
        updated_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp

    ProgramSettings:
      type: object
      properties:
        program_name:
          type: string
          description: Display name shown to customers
          example: "Rexus Rewards"
        program_description:
          type: string
          description: Short description of the program
        min_redemption_points:
          type: integer
          minimum: 0
          description: Minimum points needed to redeem
          example: 100
        max_redemption_percentage:
          type: integer
          minimum: 0
          maximum: 100
          description: Maximum percentage of order that can be paid with points
          example: 50
        redemption_increments:
          type: integer
          minimum: 1
          description: Points must be redeemed in multiples of this value
          example: 100
        tier_evaluation_period_days:
          type: integer
          minimum: 1
          description: How often tiers are re-evaluated
          example: 30
        allow_point_transfers:
          type: boolean
          description: Allow customers to transfer points to others
        allow_negative_balance:
          type: boolean
          description: Allow negative point balances
        referrer_bonus_points:
          type: integer
          description: Points given to the referrer
          example: 500
        referee_bonus_points:
          type: integer
          description: Points given to the referred friend
          example: 250
        referral_validity_days:
          type: integer
          description: How long referral codes remain valid
          example: 30
        review_reward_points:
          type: integer
          description: Points awarded for product reviews
          example: 50
        birthday_reward_points:
          type: integer
          description: Birthday bonus points
          example: 100
        signup_bonus_points:
          type: integer
          description: Welcome bonus for new customers
          example: 100
        max_points_per_order:
          type: integer
          nullable: true
          description: Maximum points that can be earned per order
        notify_on_points_earned:
          type: boolean
        notify_on_points_expiring:
          type: boolean
        notify_on_tier_change:
          type: boolean
        expiry_warning_days:
          type: integer
          description: Days before expiry to send warning
          example: 30
        enable_referral_program:
          type: boolean
        enable_review_rewards:
          type: boolean
        enable_birthday_rewards:
          type: boolean
        enable_signup_bonus:
          type: boolean
        enable_tier_system:
          type: boolean
        custom_settings:
          type: object
          additionalProperties: true
          description: Store-specific custom configuration

    UpdateSettingsRequest:
      type: object
      description: All fields are optional - only send fields you want to update
      properties:
        is_active:
          type: boolean
        points_per_currency:
          type: string
          pattern: '^\d+(\.\d+)?$'
        currency_per_point:
          type: string
          pattern: '^\d+(\.\d+)?$'
        default_expiry_days:
          type: integer
          minimum: 0
        expiration_strategy:
          type: string
          enum: [fifo, lifo]
        enable_expiry_warnings:
          type: boolean
        settings:
          $ref: ''./schemas.yaml#/schemas/ProgramSettings'

    UpdateSettingsResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        message:
          type: string
        updated_at:
          type: string
          format: date-time

    LoyaltyTier:
      type: object
      properties:
        id:
          type: string
          format: uuid
        storefront_id:
          type: string
          format: uuid
        tier_name:
          type: string
          enum: [bronze, silver, gold, platinum]
        display_name:
          type: string
        description:
          type: string
        min_points:
          type: integer
        max_points:
          type: integer
          nullable: true
        benefits:
          type: object
          properties:
            free_shipping:
              type: boolean
            priority_support:
              type: boolean
            exclusive_deals:
              type: boolean
            early_access:
              type: boolean
            birthday_bonus:
              type: integer
            points_multiplier:
              type: number
              format: float
        tier_order:
          type: integer
        is_active:
          type: boolean
        color:
          type: string
          pattern: '^#[0-9A-F]{6}$'
        icon_url:
          type: string
          format: uri
        badge_url:
          type: string
          format: uri
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LoyaltyRule:
      type: object
      properties:
        id:
          type: string
          format: uuid
        storefront_id:
          type: string
          format: uuid
        rule_name:
          type: string
        display_name:
          type: string
        description:
          type: string
        rule_type:
          type: string
          enum: [first_order, payment_method, category, order_amount]
        bonus_points:
          type: integer
        is_active:
          type: boolean
        conditions:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time

    AffiliateListResponse:
      type: object
      description: Response object for affiliate listing
      properties:
        affiliates:
          type: array
          description: List of affiliates (customers who have made referrals)
          items:
            $ref: '#/components/schemas/Affiliate'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'
      required:
        - affiliates
        - pagination

    Affiliate:
      type: object
      description: A customer who has referred others
      properties:
        customer_id:
          type: string
          format: uuid
          description: Unique customer identifier
          example: "8149a7e1-0b1b-4245-9562-4e277582537c"
        customer_name:
          type: string
          description: Customer's full name
          example: "John Doe"
        customer_email:
          type: string
          format: email
          description: Customer's email address
          example: "john.doe@example.com"
        customer_phone:
          type: string
          format: phone
          nullable: true
          description: Customer's phone number (may be null)
          example: "+1234567890"
        referral_code:
          type: string
          description: The customer's unique referral code
          example: "REF-ABC123"
        status:
          type: string
          enum: [active, inactive, new]
          description: |
            Affiliate activity status:
            - `active`: Has made a referral within the last 30 days
            - `inactive`: No referrals in the last 30+ days
            - `new`: Joined the referral program within the last 7 days
          example: "active"
        total_referrals:
          type: integer
          description: Total number of successful referrals made by this affiliate
          minimum: 0
          example: 15
        joined_at:
          type: string
          format: date-time
          description: When the affiliate made their first referral (ISO 8601)
          example: "2024-01-15T10:30:00+07:00"
        last_referral_date:
          type: string
          format: date-time
          nullable: true
          description: When the affiliate made their most recent referral (ISO 8601)
          example: "2024-12-28T14:20:00+07:00"
        special_rules:
          type: array
          description: List of special loyalty rules assigned to this affiliate
          items:
            $ref: '#/components/schemas/AffiliateSpecialRule'
          example: []
      required:
        - customer_id
        - customer_name
        - customer_email
        - referral_code
        - status
        - total_referrals
        - joined_at

    AffiliateSpecialRule:
      type: object
      description: A special loyalty rule assigned to an affiliate
      properties:
        rule_id:
          type: string
          format: uuid
          description: Unique rule identifier
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        rule_name:
          type: string
          description: Name of the special rule
          example: "VIP Referrer Bonus"
        rule_type:
          type: string
          enum: [referral, product_category, order_value, customer_segment, time_based]
          description: Type of special rule
          example: "referral"
        calculation_type:
          type: string
          enum: [fixed_points, percentage_multiplier, flat_multiplier]
          description: How points are calculated
          example: "fixed_points"
        points_value:
          type: integer
          description: Points value for this rule (when applicable)
          example: 500
        priority:
          type: integer
          description: Rule priority (higher = evaluated first)
          minimum: 1
          example: 10
        is_active:
          type: boolean
          description: Whether the rule is currently active
          example: true
      required:
        - rule_id
        - rule_name
        - rule_type
        - calculation_type
        - points_value
        - priority
        - is_active

    PaginationInfo:
      type: object
      description: Pagination metadata
      properties:
        page:
          type: integer
          minimum: 1
          description: Current page number
          example: 1
        per_page:
          type: integer
          minimum: 1
          maximum: 100
          description: Number of items per page
          example: 20
        total:
          type: integer
          minimum: 0
          description: Total number of affiliates (across all pages)
          example: 45
        total_pages:
          type: integer
          minimum: 0
          description: Total number of pages
          example: 3
        has_next:
          type: boolean
          description: Whether there is a next page
          example: true
        has_previous:
          type: boolean
          description: Whether there is a previous page
          example: false
      required:
        - page
        - per_page
        - total
        - total_pages
        - has_next
        - has_previous

  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "unauthorized"
              message:
                type: string
                example: "Authentication required"
              meta:
                type: object
                properties:
                  http_status:
                    type: integer
                    example: 401

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "forbidden"
              message:
                type: string
                example: "Storefront context required"
              meta:
                type: object
                properties:
                  http_status:
                    type: integer
                    example: 403

    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "bad_request"
              message:
                type: string
                example: "No storefront associated with admin account"
              meta:
                type: object
                properties:
                  http_status:
                    type: integer
                    example: 400

    ValidationError:
      description: Validation failed
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "bad_request"
              message:
                type: string
                example: "Invalid settings update"
              meta:
                type: object
                properties:
                  http_status:
                    type: integer
                    example: 400
                  details:
                    type: string
                    example: "points_per_currency must be greater than 0"

    InternalServerError:
      description: Server error
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "internal_server_error"
              message:
                type: string
                example: "Failed to fetch settings"
              meta:
                type: object
                properties:
                  http_status:
                    type: integer
                    example: 500
