openapi: 3.0.3
info:
  title: SmartSeller Admin Loyalty API
  description: |
    Admin API for managing loyalty programs, viewing customer transactions,
    managing tiers, and configuring loyalty settings.
  version: 1.0.0
  contact:
    name: SmartSeller API Team
    email: api@smartseller.com

servers:
  - url: http://localhost:8090
    description: Development server
  - url: https://api.smartseller.com
    description: Production server

tags:
  - name: Admin Loyalty Transactions
    description: View and manage loyalty transactions
  - name: Admin Loyalty Accounts
    description: View and manage customer loyalty accounts

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Admin JWT token from authentication

  schemas:
    AdminTransactionItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Transaction unique identifier
        account_id:
          type: string
          format: uuid
          description: Loyalty account ID
        customer_id:
          type: string
          format: uuid
          description: Customer unique identifier
        type:
          type: string
          enum: [earn, redeem, expire, adjustment, bonus, refund, reversal]
          description: Transaction type
        status:
          type: string
          enum: [pending, completed, failed, reversed]
          description: Transaction status
        points:
          type: integer
          description: Points amount (positive for earn, negative for redeem)
        balance_before:
          type: integer
          description: Account balance before transaction
        balance_after:
          type: integer
          description: Account balance after transaction
        description:
          type: string
          description: Human-readable description
        source:
          type: string
          enum: [order, referral, review, birthday, signup, manual, promotion, tier_upgrade, social_share, survey]
          nullable: true
          description: Points source
        order_id:
          type: string
          format: uuid
          nullable: true
          description: Related order ID if applicable
        idempotency_key:
          type: string
          nullable: true
          description: Duplicate prevention key
        is_reversed:
          type: boolean
          description: Whether transaction was reversed
        reversal_reason:
          type: string
          nullable: true
          description: Reason for reversal if reversed
        admin_id:
          type: string
          format: uuid
          nullable: true
          description: Admin who created the transaction (for manual adjustments)
        created_at:
          type: string
          format: date-time
      required:
        - id
        - account_id
        - customer_id
        - type
        - status
        - points
        - balance_before
        - balance_after
        - description
        - created_at

    PaginationInfo:
      type: object
      properties:
        current_page:
          type: integer
          minimum: 1
        per_page:
          type: integer
          minimum: 1
          maximum: 200
        total_records:
          type: integer
          minimum: 0
        total_pages:
          type: integer
          minimum: 0
        has_next:
          type: boolean
        has_previous:
          type: boolean
      required:
        - current_page
        - per_page
        - total_records
        - total_pages
        - has_next
        - has_previous

    TransactionsSummary:
      type: object
      description: Summary statistics for transactions
      properties:
        total_transactions:
          type: integer
          description: Total number of transactions
        total_points_earned:
          type: integer
          description: Total points earned (positive)
        total_points_spent:
          type: integer
          description: Total points spent/redeemed
        earn_count:
          type: integer
          description: Number of earn transactions
        redeem_count:
          type: integer
          description: Number of redeem transactions
        adjust_count:
          type: integer
          description: Number of adjustment transactions
        reversed_count:
          type: integer
          description: Number of reversed transactions
      required:
        - total_transactions
        - total_points_earned
        - total_points_spent
        - earn_count
        - redeem_count

    ListTransactionsResponse:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/AdminTransactionItem'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'
        summary:
          $ref: '#/components/schemas/TransactionsSummary'
      required:
        - transactions
        - pagination
        - summary

    ReverseTransactionRequest:
      type: object
      properties:
        reason:
          type: string
          minLength: 10
          description: Reason for reversal (minimum 10 characters)
      required:
        - reason

    ReverseTransactionResponse:
      type: object
      properties:
        original_transaction_id:
          type: string
          format: uuid
        reversal_transaction_id:
          type: string
          format: uuid
        account_id:
          type: string
          format: uuid
        points_reversed:
          type: integer
        balance_before:
          type: integer
        balance_after:
          type: integer
        reason:
          type: string
        reversed_by:
          type: string
        reversed_at:
          type: string
          format: date-time
        message:
          type: string
      required:
        - original_transaction_id
        - reversal_transaction_id
        - points_reversed
        - reason

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        error:
          type: string
          description: Error code
        error_detail:
          type: string
          description: Detailed error message
        validation_errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

paths:
  /api/v1/admin/loyalty/transactions:
    get:
      tags:
        - Admin Loyalty Transactions
      summary: List all loyalty transactions
      description: |
        Retrieves paginated list of all loyalty transactions for the storefront.
        Supports filtering by transaction type, status, and account ID.
      operationId: listLoyaltyTransactions
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          description: Items per page (max 200 for admin)
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: type
          in: query
          description: Filter by transaction type
          schema:
            type: string
            enum: [earn, redeem, expire, adjustment, bonus, refund, reversal]
        - name: status
          in: query
          description: Filter by transaction status
          schema:
            type: string
            enum: [pending, completed, failed, reversed]
        - name: account_id
          in: query
          description: Filter by specific loyalty account ID
          schema:
            type: string
            format: uuid
        - name: storefront_id
          in: query
          description: Filter by storefront ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Transactions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/ListTransactionsResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Transactions retrieved successfully"
                    data:
                      transactions:
                        - id: "tx-uuid-1"
                          account_id: "b0713dea-5b83-4184-ba52-8a42174534f4"
                          customer_id: "550e8400-e29b-41d4-a716-446655440000"
                          type: earn
                          status: completed
                          points: 4490
                          balance_before: 0
                          balance_after: 4490
                          description: "Points earned from order #1026"
                          source: order
                          order_id: "fb6ff4d7-aa24-40c6-8258-d26a938e5e20"
                          idempotency_key: "order_completed_fb6ff4d7-..."
                          is_reversed: false
                          created_at: "2026-01-08T22:31:37Z"
                        - id: "tx-uuid-2"
                          account_id: "acc-uuid-2"
                          customer_id: "customer-uuid-2"
                          type: earn
                          status: completed
                          points: 1000
                          balance_before: 1000
                          balance_after: 2000
                          description: "Points earned from referral"
                          source: referral
                          order_id: null
                          is_reversed: false
                          created_at: "2026-01-08T20:00:00Z"
                      pagination:
                        current_page: 1
                        per_page: 50
                        total_records: 2
                        total_pages: 1
                        has_next: false
                        has_previous: false
                      summary:
                        total_transactions: 2
                        total_points_earned: 5490
                        total_points_spent: 0
                        earn_count: 2
                        redeem_count: 0
                        adjust_count: 0
                        reversed_count: 0
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/admin/loyalty/transactions/{id}/reverse:
    post:
      tags:
        - Admin Loyalty Transactions
      summary: Reverse a transaction
      description: |
        Reverses a loyalty transaction, refunding points to the customer's account.
        This creates a new reversal transaction linked to the original.
      operationId: reverseLoyaltyTransaction
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Transaction ID to reverse
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReverseTransactionRequest'
            examples:
              reversal:
                value:
                  reason: "Order was cancelled and refunded by customer request"
      responses:
        '200':
          description: Transaction reversed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/ReverseTransactionResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Transaction reversed successfully"
                    data:
                      original_transaction_id: "tx-uuid-1"
                      reversal_transaction_id: "tx-reversal-uuid"
                      account_id: "b0713dea-5b83-4184-ba52-8a42174534f4"
                      points_reversed: 4490
                      balance_before: 4490
                      balance_after: 0
                      reason: "Order was cancelled and refunded"
                      reversed_by: "admin-uuid"
                      reversed_at: "2026-01-08T23:00:00Z"
                      message: "4490 points have been reversed"
        '400':
          description: Bad request - transaction already reversed or invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_reversed:
                  value:
                    success: false
                    message: "Transaction is already reversed"
                    error: "transaction_already_reversed"
                invalid_reason:
                  value:
                    success: false
                    message: "Reason must be at least 10 characters"
                    error: "validation_error"
                    validation_errors:
                      - field: reason
                        message: "min length is 10"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Transaction not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Transaction not found"
                error: "not_found"

  /api/v1/admin/loyalty/accounts/{id}:
    get:
      tags:
        - Admin Loyalty Accounts
      summary: Get loyalty account details
      description: |
        Retrieves detailed information about a specific loyalty account,
        including current balance, tier, and transaction history summary.
      operationId: getLoyaltyAccountDetails
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Loyalty account ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Account retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/LoyaltyAccountDetails'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/admin/loyalty/accounts:
    get:
      tags:
        - Admin Loyalty Accounts
      summary: List loyalty accounts
      description: |
        Retrieves paginated list of loyalty accounts with optional filtering.
      operationId: listLoyaltyAccounts
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: status
          in: query
          description: Filter by account status
          schema:
            type: string
            enum: [active, inactive, suspended]
        - name: tier
          in: query
          description: Filter by tier level
          schema:
            type: string
            enum: [bronze, silver, gold, platinum]
        - name: storefront_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Accounts retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      accounts:
                        type: array
                        items:
                          $ref: '#/components/schemas/LoyaltyAccountDetails'
                      pagination:
                        $ref: '#/components/schemas/PaginationInfo'

  schemas:
    LoyaltyAccountDetails:
      type: object
      properties:
        id:
          type: string
          format: uuid
        customer_id:
          type: string
          format: uuid
        customer_email:
          type: string
          format: email
        customer_name:
          type: string
        storefront_id:
          type: string
          format: uuid
        current_balance:
          type: integer
        pending_points:
          type: integer
        available_balance:
          type: integer
        total_points_earned:
          type: integer
        total_points_redeemed:
          type: integer
        current_tier:
          type: string
          enum: [bronze, silver, gold, platinum]
        points_to_next_tier:
          type: integer
        status:
          type: string
          enum: [active, inactive, suspended]
        is_frozen:
          type: boolean
        frozen_reason:
          type: string
          nullable: true
        lifetime_orders_count:
          type: integer
        lifetime_spend:
          type: number
          format: float
        referral_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
